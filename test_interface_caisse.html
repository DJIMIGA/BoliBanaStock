<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Interface Caisse Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">
            <i class="fas fa-cash-register"></i>
            Test Interface Caisse Scanner
        </h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="test-section">
                    <h3>üîç Test de Recherche</h3>
                    <div class="mb-3">
                        <label for="searchInput" class="form-label">Code-barres, CUG ou nom:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchInput" placeholder="Ex: 57851, 3600550964707...">
                            <button class="btn btn-primary" onclick="testSearch()">
                                <i class="fas fa-search"></i> Tester
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h5>Tests rapides:</h5>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="testCode('57851')">CUG: 57851</button>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="testCode('3600550964707')">EAN: 3600550964707</button>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="testCode('18415')">CUG: 18415</button>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="testCode('99999')">Code inexistant</button>
                    </div>
                </div>
                
                <div class="test-section">
                    <h3>üìä R√©sultats du Test</h3>
                    <div id="testResults"></div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="test-section">
                    <h3>üîß Informations de D√©bogage</h3>
                    <div id="debugInfo">
                        <p><strong>URL de test:</strong> <span id="testUrl">Chargement...</span></p>
                        <p><strong>CSRF Token:</strong> <span id="csrfToken">Chargement...</span></p>
                        <p><strong>Status:</strong> <span id="status">En attente...</span></p>
                    </div>
                </div>
                
                <div class="test-section">
                    <h3>üìù Log des Requ√™tes</h3>
                    <div id="requestLog" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8000';
        const SEARCH_ENDPOINT = '/sales/cash-register-scanner/';
        
        // √âl√©ments DOM
        const searchInput = document.getElementById('searchInput');
        const testResults = document.getElementById('testResults');
        const debugInfo = document.getElementById('debugInfo');
        const requestLog = document.getElementById('requestLog');
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            updateDebugInfo();
            log('üöÄ Interface de test initialis√©e');
        });
        
        // Fonctions utilitaires
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            requestLog.innerHTML += `[${timestamp}] ${message}\n`;
            requestLog.scrollTop = requestLog.scrollHeight;
        }
        
        function updateDebugInfo() {
            document.getElementById('testUrl').textContent = API_BASE_URL + SEARCH_ENDPOINT;
            document.getElementById('csrfToken').textContent = 'Non disponible (CORS)';
            document.getElementById('status').textContent = 'Pr√™t';
        }
        
        function showResult(message, type = 'info') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${message}`;
            testResults.appendChild(resultDiv);
            testResults.scrollTop = testResults.scrollHeight;
        }
        
        function clearResults() {
            testResults.innerHTML = '';
        }
        
        // Test de recherche
        function testSearch() {
            const query = searchInput.value.trim();
            if (!query) {
                showResult('Veuillez saisir un code √† tester', 'error');
                return;
            }
            
            clearResults();
            log(`üîç Test de recherche pour: ${query}`);
            showResult(`Test de recherche pour: ${query}`, 'info');
            
            // Simuler la requ√™te AJAX
            simulateSearch(query);
        }
        
        function testCode(code) {
            searchInput.value = code;
            testSearch();
        }
        
        // Simulation de la requ√™te AJAX
        function simulateSearch(query) {
            log(`üì° Envoi de la requ√™te POST vers ${SEARCH_ENDPOINT}`);
            showResult('Envoi de la requ√™te...', 'info');
            
            // Cr√©er la requ√™te
            const formData = new FormData();
            formData.append('search', query);
            
            // Headers pour simuler Django
            const headers = {
                'X-Requested-With': 'XMLHttpRequest'
            };
            
            // Effectuer la requ√™te
            fetch(API_BASE_URL + SEARCH_ENDPOINT, {
                method: 'POST',
                body: formData,
                headers: headers
            })
            .then(response => {
                log(`üì• R√©ponse re√ßue: ${response.status} ${response.statusText}`);
                showResult(`R√©ponse re√ßue: ${response.status} ${response.statusText}`, 'info');
                return response.json();
            })
            .then(data => {
                log(`üìä Donn√©es re√ßues: ${JSON.stringify(data, null, 2)}`);
                
                if (data.success) {
                    showResult(`‚úÖ PRODUIT TROUV√â: ${data.product.name}`, 'success');
                    showResult(`   CUG: ${data.product.cug}`, 'success');
                    showResult(`   Prix: ${data.product.selling_price} FCFA`, 'success');
                    showResult(`   Stock: ${data.product.quantity}`, 'success');
                    showResult(`   Type de recherche: ${data.search_type}`, 'success');
                } else {
                    showResult(`‚ùå PRODUIT NON TROUV√â: ${data.error}`, 'error');
                    if (data.suggestions && data.suggestions.length > 0) {
                        showResult(`üí° Suggestions disponibles: ${data.suggestions.length}`, 'info');
                        data.suggestions.forEach(suggestion => {
                            showResult(`   - ${suggestion.text}`, 'info');
                        });
                    }
                }
            })
            .catch(error => {
                log(`üí• Erreur: ${error.message}`);
                showResult(`üí• Erreur lors de la recherche: ${error.message}`, 'error');
                
                // Afficher des informations de d√©bogage
                showResult('üí° V√©rifiez que le serveur Django est d√©marr√© sur le port 8000', 'info');
                showResult('üí° V√©rifiez que vous √™tes connect√© √† l\'application', 'info');
                showResult('üí° V√©rifiez les logs du serveur Django', 'info');
            });
        }
        
        // Gestion des √©v√©nements
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                testSearch();
            }
        });
    </script>
</body>
</html>
