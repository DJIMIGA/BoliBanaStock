[phases.setup]
nixPkgs = ["python311", "python311Packages.pip", "nodejs-18_x"]

[phases.install]
cmds = [
    "pip install --no-cache-dir --upgrade pip",
    "pip install --no-cache-dir -r requirements.txt",
    "pip install --no-cache-dir requests>=2.31.0",
    "pip install --no-cache-dir sendgrid>=6.10.0",
    "echo 'Python dependencies installed successfully'",
    "python -c 'import sendgrid; print(f\"âœ… SendGrid installÃ©: version {sendgrid.__version__}\")' || echo 'âš ï¸ SendGrid non trouvÃ© aprÃ¨s installation'",
    "pip list | grep -i sendgrid || echo 'âš ï¸ SendGrid non trouvÃ© dans pip list'",
    "echo 'ğŸ¨ VÃ©rification de Node.js et npm pour Tailwind CSS...'",
    "node --version && echo 'âœ… Node.js disponible' || echo 'âŒ Node.js non trouvÃ©'",
    "npm --version && echo 'âœ… npm disponible' || echo 'âŒ npm non trouvÃ©'",
    "echo 'ğŸ“ VÃ©rification des rÃ©pertoires et fichiers Tailwind...'",
    "test -d theme && echo 'âœ… RÃ©pertoire theme existe' || echo 'âŒ RÃ©pertoire theme manquant'",
    "test -f static/css/src/input.css && echo 'âœ… input.css existe' || echo 'âŒ input.css manquant'",
    "test -f theme/package.json && echo 'âœ… package.json existe' || echo 'âŒ package.json manquant'",
    "mkdir -p static/css/dist && echo 'âœ… RÃ©pertoire dist crÃ©Ã©'",
    "cd theme && echo 'ğŸ“¦ Installation des dÃ©pendances npm...' && npm install",
    "cd theme && echo 'ğŸ“‹ Liste des packages npm installÃ©s:' && npm list --depth=0 || echo 'âš ï¸ Impossible de lister les packages npm'"
]

[phases.build]
cmds = [
    "echo 'ğŸ¨ Phase BUILD - GÃ©nÃ©ration de Tailwind CSS...'",
    "echo 'ğŸ“ RÃ©pertoire de travail:' && pwd",
    "echo 'ğŸ“ VÃ©rification de Node.js et npm dans la phase BUILD:'",
    "node --version || echo 'âŒ Node.js non disponible'",
    "npm --version || echo 'âŒ npm non disponible'",
    "echo 'ğŸ“ VÃ©rification des rÃ©pertoires:'",
    "test -d theme && echo 'âœ… RÃ©pertoire theme existe' || echo 'âŒ RÃ©pertoire theme manquant'",
    "test -f static/css/src/input.css && echo 'âœ… input.css existe' || echo 'âŒ input.css manquant'",
    "test -f theme/package.json && echo 'âœ… package.json existe' || echo 'âŒ package.json manquant'",
    "echo 'ğŸ“ Contenu du rÃ©pertoire theme:' && ls -la theme/ || echo 'âš ï¸ Impossible de lister theme/'",
    "echo 'ğŸ“ VÃ©rification de node_modules:' && test -d theme/node_modules && echo 'âœ… node_modules existe' || echo 'âš ï¸ node_modules n'existe pas (sera installÃ© si nÃ©cessaire)'",
    "echo 'ğŸ“ Contenu de static/css/dist avant build:' && ls -la static/css/dist/ 2>/dev/null || echo 'âš ï¸ RÃ©pertoire dist vide ou inexistant'",
    "mkdir -p static/css/dist && echo 'âœ… RÃ©pertoire dist crÃ©Ã©/vÃ©rifiÃ©'",
    "echo 'ğŸ”¨ ExÃ©cution de npm run build dans theme/...'",
    "cd theme && npm run build 2>&1 || (echo 'âŒ Erreur lors de npm run build, tentative de rÃ©installation...' && npm install && npm run build 2>&1 || (echo 'âŒ Ã‰chec dÃ©finitif de npm run build' && exit 1)) && cd ..",
    "echo 'ğŸ“ Contenu de static/css/dist aprÃ¨s build:' && ls -la static/css/dist/ 2>/dev/null || echo 'âš ï¸ Impossible de lister dist/'",
    "test -f static/css/dist/output.css && echo 'âœ… Tailwind CSS gÃ©nÃ©rÃ© avec succÃ¨s: static/css/dist/output.css' && ls -lh static/css/dist/output.css || (echo 'âŒ Erreur: output.css non gÃ©nÃ©rÃ© aprÃ¨s npm run build' && echo 'ğŸ“‹ VÃ©rification du rÃ©pertoire theme:' && ls -la theme/ && echo 'ğŸ“‹ VÃ©rification du rÃ©pertoire static/css/dist:' && (ls -la static/css/dist/ 2>/dev/null || echo 'RÃ©pertoire dist n'existe pas') && echo 'ğŸ“‹ VÃ©rification de node_modules:' && (test -d theme/node_modules && echo 'âœ… node_modules existe' || echo 'âŒ node_modules manquant') && echo 'ğŸ“‹ Tentative de gÃ©nÃ©ration manuelle avec npx...' && cd theme && npx tailwindcss -i ../static/css/src/input.css -o ../static/css/dist/output.css --minify 2>&1 && cd .. && (test -f static/css/dist/output.css && echo 'âœ… GÃ©nÃ©ration manuelle rÃ©ussie' || (echo 'âŒ Ã‰chec de la gÃ©nÃ©ration manuelle' && exit 1)))",
    "echo 'ğŸ“¦ VÃ©rification du CSS avant collectstatic:' && test -f static/css/dist/output.css && echo 'âœ… CSS source existe' && wc -c static/css/dist/output.css || echo 'âŒ CSS source manquant'",
    "echo 'ğŸ“¦ Collecte des fichiers statiques avec collectstatic...'",
    "DJANGO_SETTINGS_MODULE=bolibanastock.settings_railway python manage.py collectstatic --noinput --clear",
    "echo 'ğŸ“ VÃ©rification de la collecte de output.css:' && test -f staticfiles/css/dist/output.css && echo 'âœ… output.css collectÃ© dans staticfiles/' && ls -lh staticfiles/css/dist/output.css && wc -c staticfiles/css/dist/output.css || (echo 'âš ï¸ output.css non trouvÃ© dans staticfiles/' && echo 'ğŸ“‹ Tentative de copie manuelle...' && mkdir -p staticfiles/css/dist && cp static/css/dist/output.css staticfiles/css/dist/output.css && echo 'âœ… CSS copiÃ© manuellement' && ls -lh staticfiles/css/dist/output.css)",
    "echo 'ğŸ“‹ VÃ©rification du manifest WhiteNoise:' && test -f staticfiles/staticfiles.json && echo 'âœ… Manifest crÃ©Ã©' && (grep -q 'output.css' staticfiles/staticfiles.json && echo 'âœ… output.css trouvÃ© dans le manifest' || (echo 'âš ï¸ output.css non trouvÃ© dans le manifest, rÃ©gÃ©nÃ©ration...' && DJANGO_SETTINGS_MODULE=bolibanastock.settings_railway python manage.py collectstatic --noinput)) || echo 'âš ï¸ Manifest non crÃ©Ã©'"
]

[start]
cmd = "python deploy_railway.py && gunicorn bolibanastock.wsgi:application --bind 0.0.0.0:$PORT"
