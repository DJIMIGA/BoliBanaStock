{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load inventory_filters %}

{% block content %}
<div class="space-y-6">
    <!-- Message de configuration du site -->
    {% if needs_configuration %}
    <div class="bg-bolibana-50 border border-bolibana-200 rounded-xl p-4 mb-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center flex-1">
                <div class="p-2 rounded-lg bg-bolibana-100">
                    <i class="fas fa-cog text-bolibana-600 text-lg"></i>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-base font-bold text-bolibana-700 mb-1">Configuration requise</h3>
                    <p class="text-sm text-bolibana-600">
                        Configurez votre site pour commencer à utiliser BoliBana Stock.
                    </p>
                </div>
            </div>
            <a href="{% url 'core:configuration' %}" 
               class="ml-4 bg-bolibana-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-bolibana-600 transition-colors duration-200 whitespace-nowrap">
                Configurer
            </a>
        </div>
    </div>
    {% endif %}

    <!-- En-tête -->
    <div class="bg-white rounded-xl shadow-md p-5">
        <h1 class="text-xl font-bold text-neutral-900 mb-1">
                {% if site_config %}
                {{ site_config.nom_societe }}
                {% else %}
                BoliBana Stock
                {% endif %}
            </h1>
        <p class="text-sm text-neutral-600">
                {% if site_config %}
                    {{ site_config.description|default:"Gestion d'entreprise • Stock • Caisse" }}
                    {% if site_config.devise %}
                        <span class="inline-flex items-center px-2 py-1 ml-2 text-xs font-medium bg-bolibana-100 text-bolibana-800 rounded-full">
                            <i class="fas fa-coins mr-1"></i>
                        {{ site_config.devise }}
                        </span>
                    {% endif %}
                {% else %}
                    Gestion d'entreprise • Stock • Caisse
                {% endif %}
            </p>
    </div>

    <!-- Statistiques principales -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Total Produits -->
        <a href="{% url 'inventory:product_list' %}" class="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-200 border-l-4 border-bolibana-500 p-4 cursor-pointer block">
            <div class="flex items-center">
                <div class="p-2 rounded-lg bg-bolibana-50">
                    <i class="fas fa-box text-bolibana-500 text-lg"></i>
                </div>
                <div class="ml-3 flex-1">
                    <p class="text-xs font-medium text-neutral-500 uppercase tracking-wide">Total Produits</p>
                    <p class="text-xl font-bold text-neutral-900 mt-1">{{ total_products }}</p>
                </div>
            </div>
        </a>

        <!-- Stock bas -->
        <a href="{% url 'inventory:product_list' %}?filter=low_stock" class="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-200 border-l-4 border-gold-500 p-4 cursor-pointer block">
            <div class="flex items-center">
                <div class="p-2 rounded-lg bg-gold-50">
                    <i class="fas fa-exclamation-triangle text-gold-500 text-lg"></i>
                </div>
                <div class="ml-3 flex-1">
                    <p class="text-xs font-medium text-neutral-500 uppercase tracking-wide">Stock bas</p>
                    <p class="text-xl font-bold text-neutral-900 mt-1">{{ low_stock_products }}</p>
                </div>
            </div>
        </a>

        <!-- Rupture de stock -->
        <a href="{% url 'inventory:product_list' %}?filter=out_of_stock" class="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-200 border-l-4 border-red-500 p-4 cursor-pointer block">
            <div class="flex items-center">
                <div class="p-2 rounded-lg bg-red-50">
                    <i class="fas fa-times-circle text-red-500 text-lg"></i>
                </div>
                <div class="ml-3 flex-1">
                    <p class="text-xs font-medium text-neutral-500 uppercase tracking-wide">Rupture</p>
                    <p class="text-xl font-bold text-neutral-900 mt-1">{{ out_of_stock_products }}</p>
                </div>
            </div>
        </a>

        <!-- CA du jour -->
        <a href="{% url 'sales:sale_list' %}" class="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-200 border-l-4 border-forest-500 p-4 cursor-pointer block">
            <div class="flex items-center">
                <div class="p-2 rounded-lg bg-forest-50">
                    <i class="fas fa-chart-line text-forest-500 text-lg"></i>
                    </div>
                <div class="ml-3 flex-1">
                    <p class="text-xs font-medium text-neutral-500 uppercase tracking-wide">CA du jour</p>
                    <p class="text-lg font-bold text-neutral-900 mt-1">{{ revenue|format_currency:site_currency }}</p>
                    <p class="text-xs text-neutral-500 mt-0.5">{{ today_sales }} ventes</p>
                </div>
            </div>
        </a>
    </div>

    <!-- Actions rapides -->
    <div class="mt-6">
        <h2 class="text-lg font-bold text-neutral-900 mb-4">Actions rapides</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <a href="{% url 'inventory:cash_register' %}" 
               class="bg-bolibana-500 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 p-4 text-center text-white">
                <i class="fas fa-cash-register text-2xl mb-2"></i>
                <p class="text-sm font-semibold">Caisse</p>
            </a>
            <a href="{% url 'inventory:product_create' %}" 
               class="bg-forest-500 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 p-4 text-center text-white">
                <i class="fas fa-plus text-2xl mb-2"></i>
                <p class="text-sm font-semibold">Nouveau produit</p>
            </a>
            <a href="{% url 'inventory:quick_scan' %}" 
               class="bg-gold-500 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 p-4 text-center text-white">
                <i class="fas fa-barcode text-2xl mb-2"></i>
                <p class="text-sm font-semibold">Scanner</p>
            </a>
            <a href="{% url 'inventory:transaction_list' %}" 
               class="bg-bolibana-500 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 p-4 text-center text-white">
                <i class="fas fa-exchange-alt text-2xl mb-2"></i>
                <p class="text-sm font-semibold">Transactions</p>
            </a>
        </div>
    </div>

    <!-- Aperçu du Rapport de Stock -->
    {% if report_stats %}
    <div class="mt-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold text-neutral-900">Aperçu du Rapport (Aujourd'hui)</h2>
            <a href="{% url 'inventory:stock_report' %}" 
               class="text-sm text-bolibana-600 hover:text-bolibana-700 font-medium flex items-center">
                Voir le rapport complet
                <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Écarts Positifs -->
            <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-200 border-l-4 border-green-500 p-4">
                <div class="flex items-center mb-3">
                    <div class="p-2 rounded-lg bg-green-50">
                        <i class="fas fa-arrow-up text-green-500 text-lg"></i>
                    </div>
                    <h3 class="ml-2 text-sm font-semibold text-gray-700">Écarts Positifs</h3>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">Déclarations</span>
                        <span class="font-medium text-green-600">{{ report_stats.pos_adj_count }}</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">Quantité (Poids)</span>
                        <span class="font-medium text-green-600">+{{ report_stats.positive_qty_weight|smart_quantity }} {{ report_stats.positive_unit_weight }}</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">Quantité (Unités)</span>
                        <span class="font-medium text-green-600">+{{ report_stats.positive_qty_quantity|smart_quantity }} {{ report_stats.positive_unit_quantity }}</span>
                    </div>
                    <div class="flex justify-between pt-2 border-t border-gray-100">
                        <span class="text-xs font-medium text-gray-700">Valeur</span>
                        <span class="text-sm font-bold text-green-700">+{{ report_stats.total_pos_val|format_currency:site_currency }}</span>
                    </div>
                </div>
            </div>

            <!-- Écarts Négatifs -->
            <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-200 border-l-4 border-red-500 p-4">
                <div class="flex items-center mb-3">
                    <div class="p-2 rounded-lg bg-red-50">
                        <i class="fas fa-arrow-down text-red-500 text-lg"></i>
                    </div>
                    <h3 class="ml-2 text-sm font-semibold text-gray-700">Écarts Négatifs</h3>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">Déclarations</span>
                        <span class="font-medium text-red-600">{{ report_stats.neg_adj_count }}</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">Quantité (Poids)</span>
                        <span class="font-medium text-red-600">-{{ report_stats.negative_qty_weight|smart_quantity }} {{ report_stats.negative_unit_weight }}</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">Quantité (Unités)</span>
                        <span class="font-medium text-red-600">-{{ report_stats.negative_qty_quantity|smart_quantity }} {{ report_stats.negative_unit_quantity }}</span>
                    </div>
                    <div class="flex justify-between pt-2 border-t border-gray-100">
                        <span class="text-xs font-medium text-gray-700">Valeur</span>
                        <span class="text-sm font-bold text-red-700">-{{ report_stats.total_neg_val|format_currency:site_currency }}</span>
                    </div>
                </div>
            </div>

            <!-- Démarque & Pertes -->
            <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-200 border-l-4 border-orange-500 p-4">
                <div class="flex items-center mb-3">
                    <div class="p-2 rounded-lg bg-orange-50">
                        <i class="fas fa-trash-alt text-orange-500 text-lg"></i>
                    </div>
                    <h3 class="ml-2 text-sm font-semibold text-gray-700">Démarque & Pertes</h3>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">Casse</span>
                        <span class="font-medium text-orange-600">{{ report_stats.loss_count }}</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">Quantité (Poids)</span>
                        <span class="font-medium text-orange-600">{{ report_stats.loss_qty_weight|smart_quantity }} {{ report_stats.loss_unit_weight }}</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">Quantité (Unités)</span>
                        <span class="font-medium text-orange-600">{{ report_stats.loss_qty_quantity|smart_quantity }} {{ report_stats.loss_unit_quantity }}</span>
                    </div>
                    <div class="flex justify-between pt-2 border-t border-gray-100">
                        <span class="text-xs font-medium text-gray-700">Valeur</span>
                        <span class="text-sm font-bold text-orange-700">{{ report_stats.loss_val|format_currency:site_currency }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Aperçu du Bilan Financier -->
    {% if report_stats %}
    <div class="mt-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold text-neutral-900">Aperçu Financier (Aujourd'hui)</h2>
            <a href="{% url 'inventory:stock_report' %}" 
               class="text-sm text-bolibana-600 hover:text-bolibana-700 font-medium flex items-center">
                Voir le rapport complet
                <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Revenus -->
            <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-200 border-l-4 border-green-500 p-4">
                <div class="flex items-center mb-3">
                    <div class="p-2 rounded-lg bg-green-50">
                        <i class="fas fa-arrow-up text-green-500 text-lg"></i>
                    </div>
                    <h3 class="ml-2 text-sm font-semibold text-gray-700">Revenus</h3>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">Chiffre d'affaires</span>
                        <span class="font-medium text-green-600">{{ report_stats.total_revenue|default:0|format_currency:site_currency }}</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">Marge brute</span>
                        <span class="font-medium text-green-600">{{ report_stats.total_margin|default:0|format_currency:site_currency }}</span>
                    </div>
                    <div class="flex justify-between pt-2 border-t border-gray-100">
                        <span class="text-xs font-medium text-gray-700">Espèces</span>
                        <span class="text-sm font-bold text-green-700">{{ report_stats.cash_revenue|default:0|format_currency:site_currency }}</span>
                    </div>
                </div>
            </div>

            <!-- Coûts -->
            <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-200 border-l-4 border-red-500 p-4">
                <div class="flex items-center mb-3">
                    <div class="p-2 rounded-lg bg-red-50">
                        <i class="fas fa-arrow-down text-red-500 text-lg"></i>
                    </div>
                    <h3 class="ml-2 text-sm font-semibold text-gray-700">Coûts</h3>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">Casse</span>
                        <span class="font-medium text-red-600">-{{ report_stats.total_losses|default:0|format_currency:site_currency }}</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">Démarque</span>
                        <span class="font-medium text-red-600">-{{ report_stats.total_shrinkage|default:0|format_currency:site_currency }}</span>
                    </div>
                    <div class="flex justify-between pt-2 border-t border-gray-100">
                        <span class="text-xs font-medium text-gray-700">Total pertes</span>
                        <span class="text-sm font-bold text-red-700">-{{ report_stats.total_costs|default:0|format_currency:site_currency }}</span>
                    </div>
                </div>
            </div>

            <!-- Résultat -->
            {% with net_profit_val=report_stats.net_profit|default:0 profit_margin_val=report_stats.profit_margin|default:0 %}
            <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-200 border-l-4 {% if net_profit_val >= 0 %}border-green-500{% else %}border-red-500{% endif %} p-4">
                <div class="flex items-center mb-3">
                    <div class="p-2 rounded-lg {% if net_profit_val >= 0 %}bg-green-50{% else %}bg-red-50{% endif %}">
                        <i class="fas fa-chart-line {% if net_profit_val >= 0 %}text-green-500{% else %}text-red-500{% endif %} text-lg"></i>
                    </div>
                    <h3 class="ml-2 text-sm font-semibold text-gray-700">Résultat</h3>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">Profit net</span>
                        <span class="font-medium {% if net_profit_val >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            {{ net_profit_val|format_currency:site_currency }}
                        </span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">Taux de profit</span>
                        <span class="font-medium {% if profit_margin_val >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            {{ profit_margin_val|floatformat:1 }}%
                        </span>
                    </div>
                    <div class="flex justify-between pt-2 border-t border-gray-100">
                        <span class="text-xs font-medium text-gray-700">Marge brute</span>
                        <span class="text-sm font-bold text-green-700">{{ report_stats.total_margin|default:0|format_currency:site_currency }}</span>
                    </div>
                </div>
            </div>
            {% endwith %}
                    <div class="flex justify-between pt-2 border-t border-gray-100">
                        <span class="text-xs font-medium text-gray-700">Marge brute</span>
                        <span class="text-sm font-bold text-green-700">{{ report_stats.total_margin|default:0|format_currency:site_currency }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Alertes et Statistiques -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
        <!-- Dernières activités -->
        <div class="lg:col-span-2 space-y-6">

            <!-- Dernières activités -->
            <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-200 p-5">
                <h2 class="text-lg font-bold text-neutral-900 mb-4">Dernières Activités</h2>
                <div class="space-y-3">
                        {% for activity in recent_activities %}
                        <a href="{{ activity.url }}" 
                       class="flex items-center p-3 rounded-lg bg-neutral-50 hover:bg-neutral-100 transition-colors duration-200">
                        <div class="p-2 rounded-lg bg-{{ activity.color }}-50">
                                <i class="fas fa-history text-{{ activity.color }}-500"></i>
                            </div>
                        <div class="ml-3 flex-1">
                                <p class="text-sm font-medium text-neutral-800">{{ activity.description }}</p>
                            <p class="text-xs text-neutral-500 mt-0.5">{{ activity.date|timesince }}</p>
                            </div>
                        </a>
                        {% empty %}
                        <p class="text-neutral-500 text-center py-4">Aucune activité récente</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Top Catégories -->
        <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-200 p-5">
            <h2 class="text-lg font-bold text-neutral-900 mb-4">Top Catégories</h2>
            <div class="space-y-3">
                        {% for category in products_by_category %}
                <div class="flex items-center justify-between p-3 rounded-lg bg-neutral-50 hover:bg-neutral-100 transition-colors duration-200">
                        <div class="flex items-center">
                        <div class="p-2 rounded-lg bg-bolibana-50">
                                <i class="fas fa-tag text-bolibana-500"></i>
                        </div>
                        <span class="ml-3 text-sm font-medium text-neutral-800">{{ category.category__name|default:"Sans catégorie" }}</span>
                    </div>
                    <span class="text-bolibana-600 font-semibold text-sm">{{ category.product_count }} produits</span>
                </div>
                {% empty %}
                <p class="text-neutral-500 text-center py-4 text-sm">Aucune catégorie disponible</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %} 