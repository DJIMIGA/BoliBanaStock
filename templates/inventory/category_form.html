{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if object %}Modifier la catégorie{% else %}Nouvelle catégorie{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            {% if object %}Modifier la catégorie{% else %}Nouvelle catégorie{% endif %}
        </h1>
    </div>

    <div class="card shadow mb-4">
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="{{ form.name.id_for_label }}">Nom</label>
                    {{ form.name }}
                    {% if form.name.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.name.errors }}
                        </div>
                    {% endif %}
                </div>

                <!-- Section pour les rayons -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Configuration du rayon</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                {{ form.is_rayon }}
                                <label class="custom-control-label" for="{{ form.is_rayon.id_for_label }}">
                                    {{ form.is_rayon.label }}
                                </label>
                            </div>
                            {% if form.is_rayon.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.is_rayon.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="form-group" id="rayon-type-group" style="display: none;">
                            <label for="{{ form.rayon_type.id_for_label }}">{{ form.rayon_type.label }}</label>
                            {{ form.rayon_type }}
                            {% if form.rayon_type.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.rayon_type.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                {{ form.is_global }}
                                <label class="custom-control-label" for="{{ form.is_global.id_for_label }}">
                                    {{ form.is_global.label }}
                                </label>
                            </div>
                            {% if form.is_global.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.is_global.errors }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="form-group" id="parent-group">
                    <label for="{{ form.parent.id_for_label }}">Rayon parent</label>
                    <select name="{{ form.parent.name }}" id="{{ form.parent.id_for_label }}" class="form-control">
                        <option value="">Sélectionnez un rayon parent</option>
                        <!-- Les options seront chargées dynamiquement -->
                    </select>
                    {% if form.parent.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.parent.errors }}
                        </div>
                    {% endif %}
                    <small class="form-text text-muted">
                        Sélectionnez le rayon principal pour cette sous-catégorie
                    </small>
                </div>

                <div class="form-group">
                    <label for="{{ form.description.id_for_label }}">Description</label>
                    {{ form.description }}
                    {% if form.description.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.description.errors }}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.image.id_for_label }}">Image</label>
                    <input type="file" name="{{ form.image.name }}" id="{{ form.image.id_for_label }}" 
                           class="form-control-file" accept="image/*" capture="environment">
                    <div class="mt-2">
                        <button type="button" onclick="openCamera()" class="btn btn-outline-primary btn-sm mr-2">
                            <i class="fas fa-camera mr-1"></i>Appareil photo
                        </button>
                        <button type="button" onclick="openGallery()" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-images mr-1"></i>Galerie
                        </button>
                    </div>
                    {% if form.image.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.image.errors }}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.order.id_for_label }}">Ordre d'affichage</label>
                    {{ form.order }}
                    {% if form.order.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.order.errors }}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <div class="custom-control custom-switch">
                        {{ form.is_active }}
                        <label class="custom-control-label" for="{{ form.is_active.id_for_label }}">Active</label>
                    </div>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-primary">
                        {% if object %}Mettre à jour{% else %}Créer{% endif %}
                    </button>
                    <a href="{% url 'inventory:category_list' %}" class="btn btn-secondary">Annuler</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function openCamera() {
    // Créer un input temporaire pour l'appareil photo
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.capture = 'environment'; // Utilise la caméra arrière par défaut
    
    input.onchange = function(e) {
        if (e.target.files && e.target.files[0]) {
            // Transférer le fichier vers l'input principal
            const mainInput = document.getElementById('{{ form.image.id_for_label }}');
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(e.target.files[0]);
            mainInput.files = dataTransfer.files;
            
            // Déclencher un événement change pour mettre à jour l'interface
            mainInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
    };
    
    input.click();
}

function openGallery() {
    // Créer un input temporaire pour la galerie
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    
    input.onchange = function(e) {
        if (e.target.files && e.target.files[0]) {
            // Transférer le fichier vers l'input principal
            const mainInput = document.getElementById('{{ form.image.id_for_label }}');
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(e.target.files[0]);
            mainInput.files = dataTransfer.files;
            
            // Déclencher un événement change pour mettre à jour l'interface
            mainInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
    };
    
    input.click();
}

// Gestion de l'affichage dynamique des champs
document.addEventListener('DOMContentLoaded', function() {
    const isRayonCheckbox = document.getElementById('{{ form.is_rayon.id_for_label }}');
    const rayonTypeGroup = document.getElementById('rayon-type-group');
    const parentGroup = document.getElementById('parent-group');
    const parentSelect = document.getElementById('{{ form.parent.id_for_label }}');
    const isGlobalCheckbox = document.getElementById('{{ form.is_global.id_for_label }}');

    // Charger les rayons disponibles
    function loadRayons() {
        fetch('/inventory/api/rayons/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    parentSelect.innerHTML = '<option value="">Sélectionnez un rayon parent</option>';
                    data.rayons.forEach(rayon => {
                        const option = document.createElement('option');
                        option.value = rayon.id;
                        option.textContent = rayon.name;
                        parentSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Erreur lors du chargement des rayons:', error);
            });
    }

    function toggleFields() {
        if (isRayonCheckbox.checked) {
            // Si c'est un rayon principal
            rayonTypeGroup.style.display = 'block';
            parentGroup.style.display = 'none';
            parentSelect.value = '';
            // Décocher automatiquement is_global pour les rayons
            isGlobalCheckbox.checked = false;
        } else {
            // Si c'est une sous-catégorie
            rayonTypeGroup.style.display = 'none';
            parentGroup.style.display = 'block';
            // Charger les rayons si pas encore fait
            if (parentSelect.children.length <= 1) {
                loadRayons();
            }
        }
    }

    // Écouter les changements
    isRayonCheckbox.addEventListener('change', toggleFields);
    
    // Initialiser l'affichage
    toggleFields();
    
    // Charger les rayons au démarrage si c'est une sous-catégorie
    if (!isRayonCheckbox.checked) {
        loadRayons();
    }
});

// Fonction pour afficher un aperçu de l'image sélectionnée
document.addEventListener('DOMContentLoaded', function() {
    const imageInput = document.getElementById('{{ form.image.id_for_label }}');
    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Supprimer l'ancien aperçu s'il existe
                const oldPreview = document.querySelector('.image-preview');
                if (oldPreview) {
                    oldPreview.remove();
                }
                
                // Créer un aperçu de l'image
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.createElement('div');
                    preview.className = 'image-preview mt-2';
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Aperçu" class="img-fluid rounded" style="max-width: 200px;">
                        <p class="text-muted mt-1 small">Fichier sélectionné: ${file.name}</p>
                    `;
                    
                    // Insérer l'aperçu après les boutons
                    const buttonsContainer = document.querySelector('.mt-2');
                    if (buttonsContainer) {
                        buttonsContainer.parentNode.insertBefore(preview, buttonsContainer.nextSibling);
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
});
</script>

{% endblock %} 