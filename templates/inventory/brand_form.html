{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if object %}Modifier la marque{% else %}Nouvelle marque{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            {% if object %}Modifier la marque{% else %}Nouvelle marque{% endif %}
        </h1>
    </div>

    <div class="card shadow mb-4">
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="{{ form.name.id_for_label }}">Nom</label>
                    {{ form.name }}
                    {% if form.name.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.name.errors }}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.description.id_for_label }}">Description</label>
                    {{ form.description }}
                    {% if form.description.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.description.errors }}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.logo.id_for_label }}">Logo</label>
                    {% if object and object.logo %}
                        <div class="mb-2">
                            <img src="{{ object.logo.url }}" alt="{{ object.name }}" style="max-height: 100px;">
                        </div>
                    {% endif %}
                    <input type="file" name="{{ form.logo.name }}" id="{{ form.logo.id_for_label }}" 
                           class="form-control-file" accept="image/*" capture="environment">
                    <div class="mt-2">
                        <button type="button" onclick="openCamera()" class="btn btn-outline-primary btn-sm mr-2">
                            <i class="fas fa-camera mr-1"></i>Appareil photo
                        </button>
                        <button type="button" onclick="openGallery()" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-images mr-1"></i>Galerie
                        </button>
                    </div>
                    {% if form.logo.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.logo.errors }}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-primary">
                        {% if object %}Mettre à jour{% else %}Créer{% endif %}
                    </button>
                    <a href="{% url 'inventory:brand_list' %}" class="btn btn-secondary">Annuler</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function openCamera() {
    // Créer un input temporaire pour l'appareil photo
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.capture = 'environment'; // Utilise la caméra arrière par défaut
    
    input.onchange = function(e) {
        if (e.target.files && e.target.files[0]) {
            // Transférer le fichier vers l'input principal
            const mainInput = document.getElementById('{{ form.logo.id_for_label }}');
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(e.target.files[0]);
            mainInput.files = dataTransfer.files;
            
            // Déclencher un événement change pour mettre à jour l'interface
            mainInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
    };
    
    input.click();
}

function openGallery() {
    // Créer un input temporaire pour la galerie
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    // Pas de capture pour permettre la sélection depuis la galerie
    
    input.onchange = function(e) {
        if (e.target.files && e.target.files[0]) {
            // Transférer le fichier vers l'input principal
            const mainInput = document.getElementById('{{ form.logo.id_for_label }}');
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(e.target.files[0]);
            mainInput.files = dataTransfer.files;
            
            // Déclencher un événement change pour mettre à jour l'interface
            mainInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
    };
    
    input.click();
}

// Fonction pour afficher un aperçu de l'image sélectionnée
document.addEventListener('DOMContentLoaded', function() {
    const logoInput = document.getElementById('{{ form.logo.id_for_label }}');
    if (logoInput) {
        logoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Supprimer l'ancien aperçu s'il existe
                const oldPreview = document.querySelector('.logo-preview');
                if (oldPreview) {
                    oldPreview.remove();
                }
                
                // Créer un aperçu de l'image
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.createElement('div');
                    preview.className = 'logo-preview mt-2';
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Aperçu" class="img-fluid rounded" style="max-width: 200px;">
                        <p class="text-muted mt-1 small">Fichier sélectionné: ${file.name}</p>
                    `;
                    
                    // Insérer l'aperçu après les boutons
                    const buttonsContainer = document.querySelector('.mt-2');
                    if (buttonsContainer) {
                        buttonsContainer.parentNode.insertBefore(preview, buttonsContainer.nextSibling);
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
});
</script>

{% endblock %} 