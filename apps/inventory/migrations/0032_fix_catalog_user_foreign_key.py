# Generated by Django 4.2.24 on 2025-10-17 06:32

from django.db import migrations, models
import django.db.models.deletion
from django.conf import settings


def fix_catalog_user_foreign_key(apps, schema_editor):
    """
    Force la correction de la contrainte de cl√© √©trang√®re pour CatalogGeneration.user
    en supprimant et recr√©ant le champ avec la bonne r√©f√©rence
    """
    CatalogGeneration = apps.get_model('inventory', 'CatalogGeneration')
    
    # Supprimer toutes les CatalogGeneration avec user_id NULL ou orphelines
    from apps.core.models import User as CoreUser
    valid_user_ids = set(CoreUser.objects.values_list('id', flat=True))
    
    # Supprimer les CatalogGeneration avec user_id NULL
    null_user_count = CatalogGeneration.objects.filter(user_id__isnull=True).count()
    if null_user_count > 0:
        print(f"üßπ Suppression de {null_user_count} g√©n√©rations avec user_id NULL...")
        CatalogGeneration.objects.filter(user_id__isnull=True).delete()
        print(f"‚úÖ {null_user_count} g√©n√©rations avec user_id NULL supprim√©es")
    
    # Supprimer les CatalogGeneration orphelines (user_id invalide)
    orphaned = CatalogGeneration.objects.exclude(user_id__in=valid_user_ids)
    count = orphaned.count()
    if count > 0:
        print(f"üßπ Suppression de {count} g√©n√©rations orphelines avant correction FK...")
        orphaned.delete()
        print(f"‚úÖ {count} g√©n√©rations orphelines supprim√©es")
    
    print("‚úÖ Contrainte de cl√© √©trang√®re corrig√©e pour CatalogGeneration.user")


def cleanup_null_users(apps, schema_editor):
    """
    Supprimer toutes les CatalogGeneration avec user_id NULL apr√®s la recr√©ation du champ
    """
    CatalogGeneration = apps.get_model('inventory', 'CatalogGeneration')
    
    # Supprimer les CatalogGeneration avec user_id NULL
    null_user_count = CatalogGeneration.objects.filter(user_id__isnull=True).count()
    if null_user_count > 0:
        print(f"üßπ Suppression de {null_user_count} g√©n√©rations avec user_id NULL apr√®s recr√©ation du champ...")
        CatalogGeneration.objects.filter(user_id__isnull=True).delete()
        print(f"‚úÖ {null_user_count} g√©n√©rations avec user_id NULL supprim√©es")
    


def reverse_fix(apps, schema_editor):
    """
    Op√©ration inverse - ne peut pas √™tre annul√©e
    """
    pass


class Migration(migrations.Migration):

    dependencies = [
        ('inventory', '0031_cleanup_orphaned_catalog_generations'),
        ('core', '0006_change_default_currency_to_fcfa'),
    ]

    operations = [
        # D'abord, supprimer toutes les CatalogGeneration orphelines et avec user_id NULL
        migrations.RunPython(
            fix_catalog_user_foreign_key,
            reverse_fix,
        ),
        # Supprimer le champ user existant
        migrations.RemoveField(
            model_name='cataloggeneration',
            name='user',
        ),
        # Recr√©er le champ user avec la bonne r√©f√©rence (nullable=True temporairement)
        migrations.AddField(
            model_name='cataloggeneration',
            name='user',
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE, 
                to=settings.AUTH_USER_MODEL, 
                verbose_name='Utilisateur',
                null=True,  # Temporairement nullable pour √©viter l'erreur
            ),
        ),
        # Supprimer les valeurs NULL restantes apr√®s la recr√©ation du champ
        migrations.RunPython(
            cleanup_null_users,
            reverse_fix,
        ),
        # Rendre le champ non-nullable avec SQL brut pour √©viter les probl√®mes de trigger
        migrations.RunSQL(
            # SQL pour rendre la colonne NOT NULL
            sql="""
                ALTER TABLE inventory_cataloggeneration 
                ALTER COLUMN user_id SET NOT NULL;
            """,
            reverse_sql="""
                ALTER TABLE inventory_cataloggeneration 
                ALTER COLUMN user_id DROP NOT NULL;
            """,
        ),
    ]
